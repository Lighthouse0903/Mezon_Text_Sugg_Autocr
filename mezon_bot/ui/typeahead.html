<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <title>Typeahead – gợi ý ngang (Tab/Enter)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            body {
                font-family: system-ui, -apple-system, Segoe UI, Roboto,
                    sans-serif;
                line-height: 1.45;
            }
            .wrap {
                max-width: 980px;
                margin: 2rem auto;
                padding: 0 1rem;
            }
            h1 {
                font-size: 28px;
                margin: 0 0 18px;
            }

            /* ----- input + overlay ----- */
            .input-wrap {
                position: relative;
                width: 100%;
            }
            .input-wrap input[type="text"] {
                width: 100%;
                font-size: 20px;
                padding: 14px 16px;
                border-radius: 8px;
                border: 1px solid #d0d5dd;
                outline: none;
                background: transparent; /* để thấy overlay bên dưới */
                position: relative;
                z-index: 2;
            }
            .input-overlay {
                position: absolute;
                inset: 0;
                pointer-events: none;
                white-space: pre-wrap;
                font-size: 20px;
                padding: 14px 16px;
                border-radius: 8px;
                font-family: inherit;
                line-height: 1.45;
                overflow: hidden;
                z-index: 1;
                color: transparent; /* chữ trong suốt, chỉ hiện nền highlight */
            }
            .input-overlay .hl {
                background: rgba(37, 99, 235, 0.12);
                border-bottom: 2px solid rgba(37, 99, 235, 0.35);
                color: transparent;
                border-radius: 3px;
            }

            .kv {
                margin-top: 12px;
                color: #344054;
            }
            .tag {
                background: #eef2ff;
                color: #344054;
                padding: 2px 8px;
                border-radius: 6px;
                display: inline-block;
            }

            /* Thanh gợi ý ngang */
            .sugg-bar {
                display: flex;
                gap: 8px;
                margin: 12px 0;
                flex-wrap: wrap;
            }
            .sugg-btn {
                flex: 1;
                padding: 8px 12px;
                background: #f1f5ff;
                border-radius: 16px;
                cursor: pointer;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-size: 16px;
                border: 1px solid #d0d5dd;
                user-select: none;
            }
            .sugg-btn.active {
                background: #dbeafe;
                border-color: #93c5fd;
            }
            .hidden {
                display: none;
            }
        </style>

        <style>
            :root[data-embed="1"] body {
                background: #fff;
            }
            :root[data-embed="1"] .wrap {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 8px 12px !important;
            }
            :root[data-embed="1"] h1 {
                display: none !important;
            }
            :root[data-embed="1"] .kv {
                display: none !important;
            }
            :root[data-embed="1"] .sugg-bar {
                margin: 6px 0 !important;
            }
            :root[data-embed="1"] input#msg {
                font-size: 16px !important;
                padding: 10px 12px !important;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <h1>Typeahead – gợi ý ngang (tối đa theo k, Tab/Enter)</h1>

            <div class="sugg-bar hidden" id="suggBar"></div>

            <div class="input-wrap">
                <div id="overlay" class="input-overlay"></div>
                <input
                    id="msg"
                    type="text"
                    placeholder="Nhập tin nhắn... (ví dụ: mình muốn đặt bàn lúc 7 giờ t)"
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                />
            </div>

            <div
                id="ac-hint"
                style="
                    margin-top: 6px;
                    font-size: 13px;
                    color: #2563eb;
                    display: none;
                "
            ></div>

            <div class="kv">context: <span id="ctx" class="tag"></span></div>
            <div class="kv">prefix: <span id="pre" class="tag"></span></div>
        </div>

        <script>
            const _params = new URLSearchParams(location.search);
            const EMBED = _params.get("embed") === "1";
            const PREFILL = _params.get("q") || "";
            let TOPK_GLOBAL = parseInt(_params.get("k") || "5", 10);
            if (!Number.isFinite(TOPK_GLOBAL) || TOPK_GLOBAL <= 0)
                TOPK_GLOBAL = 5;
            if (EMBED) document.documentElement.setAttribute("data-embed", "1");

            const API_BASE =
                "https://unthrobbing-tosha-nonruminatingly.ngrok-free.dev";
            const API_KEY = "dev-key-123";

            const MIN_PREFIX_LEN = 1;
            const DEBOUNCE_MS_1 = 200;
            const DEBOUNCE_MS_2 = 120;

            function splitContextPrefix(text) {
                const t = (text || "").trim();
                if (!t) return {context: "", prefix: ""};
                const parts = t.split(/\s+/);
                const prefix = parts.pop() || "";
                const context = parts.join(" ");
                return {context, prefix};
            }

            const $msg = document.getElementById("msg");
            const $ctx = document.getElementById("ctx");
            const $pre = document.getElementById("pre");
            const $bar = document.getElementById("suggBar");
            const $overlay = document.getElementById("overlay");
            const $acHint = document.getElementById("ac-hint");

            let inFlightCtrl = null;
            let debounceTimer = null;
            let composing = false;

            let lastAction = "user";

            $msg.addEventListener("compositionstart", () => (composing = true));
            $msg.addEventListener("compositionend", () => {
                composing = false;
                updateView();
            });

            async function fetchSuggest(context, prefix, k = TOPK_GLOBAL) {
                if (inFlightCtrl) inFlightCtrl.abort();
                inFlightCtrl = new AbortController();

                const qs = new URLSearchParams({context, k: String(k)});
                if (prefix) qs.set("prefix", prefix);

                const headers = {
                    Accept: "application/json",
                    "ngrok-skip-browser-warning": "true",
                };
                if (API_KEY) headers["x-api-key"] = API_KEY;

                const r = await fetch(`${API_BASE}/v1/suggest?${qs}`, {
                    headers,
                    signal: inFlightCtrl.signal,
                });
                if (!r.ok) {
                    const txt = await r.text().catch(() => "");
                    throw new Error(`Suggest ${r.status}: ${txt}`);
                }
                const {candidates = []} = await r.json();
                return candidates;
            }

            async function fetchAutocorrect(token) {
                if (!token) return token;
                const headers = {
                    Accept: "application/json",
                    "ngrok-skip-browser-warning": "true",
                };
                if (API_KEY) headers["x-api-key"] = API_KEY;
                try {
                    const r = await fetch(
                        `${API_BASE}/v1/autocorrect?token=${encodeURIComponent(
                            token
                        )}`,
                        {headers}
                    );
                    if (!r.ok) return token;
                    const data = await r.json();
                    return data.corrected || token;
                } catch (err) {
                    console.warn("autocorrect failed:", err);
                    return token;
                }
            }

            function renderBar(cands) {
                $bar.innerHTML = "";
                if (!cands.length) {
                    $bar.classList.add("hidden");
                    return;
                }
                $bar.classList.remove("hidden");
                cands.slice(0, TOPK_GLOBAL).forEach((w, i) => {
                    const btn = document.createElement("div");
                    btn.className = "sugg-btn" + (i === 0 ? " active" : "");
                    btn.textContent = w;
                    btn.onclick = () => pickSuggestion(w);
                    $bar.appendChild(btn);
                });
            }

            function scheduleSuggest(prefix) {
                if (composing) return;
                if (!prefix || prefix.length < MIN_PREFIX_LEN) {
                    $bar.classList.add("hidden");
                    return;
                }
                const delay =
                    prefix.length === 1 ? DEBOUNCE_MS_1 : DEBOUNCE_MS_2;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    try {
                        const {context} = splitContextPrefix($msg.value);
                        const cands = await fetchSuggest(
                            context,
                            prefix,
                            TOPK_GLOBAL
                        );
                        renderBar(cands);
                    } catch (err) {
                        if (err?.name !== "AbortError") console.error(err);
                        renderBar([]);
                    }
                }, delay);
            }

            function showAutocorrectHint(fromWord, toWord) {
                if (fromWord === toWord) {
                    $acHint.style.display = "none";
                    return;
                }
                $acHint.textContent = `Đã sửa: "${fromWord}" → "${toWord}"`;
                $acHint.style.display = "block";
                clearTimeout($acHint._timer);
                $acHint._timer = setTimeout(() => {
                    $acHint.style.display = "none";
                }, 2000);
            }

            function updateOverlay(text, highlightWord = null) {
                if (!highlightWord) {
                    $overlay.textContent = text;
                    return;
                }
                const parts = text.split(" ");
                if (
                    parts.length &&
                    parts[parts.length - 1].trim() === highlightWord.trim()
                ) {
                    parts[parts.length - 1] =
                        '<span class="hl">' +
                        parts[parts.length - 1] +
                        "</span>";
                }
                $overlay.innerHTML =
                    parts.join(" ") + (text.endsWith(" ") ? " " : "");
            }

            function pickSuggestion(word) {
                const {context} = splitContextPrefix($msg.value);
                const newVal = (context ? context + " " : "") + word + " ";
                $msg.value = newVal;
                updateView();
                updateOverlay(newVal);
                lastAction = "suggest-pick";
                $msg.focus();
            }

            function updateView() {
                const {context, prefix} = splitContextPrefix($msg.value);
                $ctx.textContent = context || "—";
                $pre.textContent = prefix || "—";
                scheduleSuggest(prefix);
                updateOverlay($msg.value);
            }

            $msg.addEventListener("input", () => {
                lastAction = "user";
                updateView();
            });

            $msg.addEventListener("keydown", async (ev) => {
                if (ev.key !== " " && ev.key !== "Enter") return;
                if (composing) return;

                if (lastAction === "suggest-pick") {
                    lastAction = "user";
                    return;
                }

                let text = $msg.value.trimEnd();
                const parts = text.split(/\s+/);
                const last = parts.pop() || "";

                const fixedLast = await fetchAutocorrect(last);
                const correctedText = [...parts, fixedLast].join(" ");

                $msg.value = correctedText + " ";
                updateOverlay(correctedText + " ", fixedLast);
                showAutocorrectHint(last, fixedLast);

                updateView();
                ev.preventDefault();

                lastAction = "auto-correct";

                try {
                    const cands = await fetchSuggest(
                        correctedText,
                        "",
                        TOPK_GLOBAL
                    );
                    renderBar(cands);
                } catch (err) {
                    console.error(err);
                    renderBar([]);
                }
            });

            document.addEventListener("keydown", (ev) => {
                if ($bar.classList.contains("hidden")) return;
                const items = Array.from($bar.querySelectorAll(".sugg-btn"));
                if (!items.length) return;

                let cur = items.findIndex((el) =>
                    el.classList.contains("active")
                );
                if (cur < 0) cur = 0;

                const setActive = (i) => {
                    items.forEach((el) => el.classList.remove("active"));
                    if (i >= 0 && i < items.length)
                        items[i].classList.add("active");
                };

                if (ev.key === "ArrowRight") {
                    ev.preventDefault();
                    setActive(Math.min(cur + 1, items.length - 1));
                } else if (ev.key === "ArrowLeft") {
                    ev.preventDefault();
                    setActive(Math.max(cur - 1, 0));
                } else if (
                    ev.key === "Tab" ||
                    (ev.key === "Enter" && document.activeElement === $msg)
                ) {
                    const active = items.find((el) =>
                        el.classList.contains("active")
                    );
                    if (active) {
                        ev.preventDefault();
                        pickSuggestion(active.textContent);
                    }
                } else if (ev.key === "Escape") {
                    $bar.classList.add("hidden");
                }
            });

            window.addEventListener("DOMContentLoaded", () => {
                if (PREFILL) $msg.value = PREFILL;
                updateView();
                updateOverlay($msg.value);
                $msg.focus();
            });
        </script>
    </body>
</html>
